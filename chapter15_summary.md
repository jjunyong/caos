# Chapter 15: 파일 시스템

## 1. 파일과 디렉터리 기본 개념

### 파일 시스템

- 운영체제 내부 프로그램으로서 파일과 디렉터리 관리
- 파일: 운영체제가 관리하는 논리적 저장 단위
- 컴퓨터 내부 저장 정보의 체계적 관리

### 디렉터리 구조

- 파일들의 체계적 분류 및 관리 구조
- Windows: 폴더, 다른 OS: 디렉터리
- **Tree 구조**로 관리, 최상단은 **루트 디렉터리**
- 리눅스/Unix: `/`(슬래시)로 표현

### 경로 종류

- **절대경로**: 루트 디렉터리부터 파일까지의 전체 경로
  - 예: `/home/cs-study/file.txt`
- **상대경로**: 현재 디렉터리 기준 경로

### 파일 메타데이터

- 파일의 위치, 형식, 크기 등 속성 정보
- 디렉터리 엔트리에 파일명과 저장 위치 정보 포함

## 2. 저장 장치 준비

### 새 저장 장치의 제약

- 새 하드디스크/SSD는 즉시 파일 저장 불가
- 파티셔닝과 포맷팅 작업 필수

### 파티셔닝 (Partitioning)

- 저장장치의 논리적 영역 구획 작업
- 서랍 칸막이와 유사한 개념
- 체계적 관리를 위한 영역 분할

### 포맷팅 (Formatting)

- 파일 시스템 설정 작업
- 파일 저장 및 관리 방식 결정
- 새 데이터 저장을 위한 준비 과정

## 3. 파일 할당 방식

### 연속 할당 (Contiguous Allocation)

- 연속된 블록에 순차적 파일 저장
- 첫 번째 블록 주소와 블록 수로 접근
- 빠른 접근, 외부 단편화 발생

### 불연속 할당 (Non-contiguous Allocation)

- 분산된 블록에 파일 저장
- **연결 할당**: 각 블록이 다음 블록 주소 포함
- **색인 할당**: 색인 블록에 모든 블록 주소 저장
- **FAT 방식**: 별도 테이블로 연결 정보 관리

## 4. FAT 파일 시스템

### FAT 파일 시스템 개요

- **File Allocation Table**의 약자
- 연결 할당 방식의 단점을 보완한 파일 시스템
- 모든 블록 연결 정보를 **별도의 테이블(FAT)로 관리**하는 것이 핵심

### FAT의 동작 원리

기존 연결 할당에서는 각 블록마다 다음 블록 주소를 저장했지만, FAT는 이 모든 연결 정보를 하나의 테이블로 분리하여 관리한다. 이를 통해 순차 접근의 한계를 극복하고 임의 접근이 가능해진다.

### 특징 및 장점

- **종류**: FAT-12, FAT-16, FAT-32 (블록 표현 비트 수)
- 임의 접근 가능
- FAT 테이블 메모리 캐시로 성능 향상
- **과거**: MS-DOS, 초기 Windows에서 주 파일 시스템
- **현재**: USB 메모리, SD 카드 등 이동식 저장장치에서 주로 사용
- 높은 호환성으로 거의 모든 운영체제에서 지원

## 5. 유닉스 파일 시스템과 inode

### 유닉스 파일 시스템 개요

- Linux/Unix 계열 운영체제에서 사용하는 파일 시스템
- **색인 할당 기법**을 사용하는 대표적인 파일 시스템
- 색인 블록을 **inode(index node)**라는 특별한 이름으로 부름
- **현재**: EXT2, EXT3, EXT4 등으로 발전 (Linux 주 파일 시스템)

### inode: 핵심 데이터 구조

- 유닉스 파일 시스템 내부에서 파일 관리를 위해 사용하는 **데이터 구조**
- 파일 시스템 자체가 아닌, 파일 시스템의 **구성 요소**
- 현대 Linux의 EXT 계열 파일 시스템들도 **유닉스 파일 시스템의 발전된 형태**이므로 동일한 inode 구조 사용
- 파일 속성 정보 + 15개 블록 주소 저장
- 파티션 내 특정 영역에 집중 관리
- inode 영역과 데이터 영역 분리

### 블록 주소 체계

#### 직접 블록 (1~12번)

- 파일 데이터 블록을 직접 가리키는 주소
- 작은 파일은 직접 블록만으로 충분
- 예: 파일 A(3개 블록), 파일 B(2개 블록) 연속 저장

#### 간접 블록 (13~15번)

- **1차 간접 블록 (13번)**: 데이터 블록 주소들을 저장하는 블록
- **2차 간접 블록 (14번)**: 1차 간접 블록들의 주소 저장
- **3차 간접 블록 (15번)**: 2차 간접 블록들의 주소 저장

### 저장 용량 계산

블록 크기 4KB, 블록 주소 4바이트 기준:

- 직접 블록: 12개
- 1차 간접: 1,024개 블록 주소 (4KB ÷ 4바이트)
- 2차 간접: 1,024 × 1,024개 블록
- 3차 간접: 1,024³개 블록

### 파일 접근 과정

`/home/cs-study/a.shell` 파일 접근:

1. 루트 디렉터리 inode(2번) 접근
2. home 디렉터리 inode(예: 121번) 탐색
3. cs-study 디렉터리 inode 탐색
4. a.shell 파일 inode 접근
5. 블록 주소로 실제 데이터 읽기

### inode와 파일 삭제 현상

실무에서 **로그 파일 삭제 후에도 디스크 사용률이 줄어들지 않는** 현상 발생

#### 참조 카운트 메커니즘

inode의 파일 참조 추적:

- **디렉터리 엔트리**: 파일명을 통한 참조
- **열린 파일 디스크립터**: 프로세스의 파일 사용
- **하드링크**: 동일 inode를 가리키는 여러 파일명

#### 파일 삭제 과정

```
1. rm 명령 실행
2. 디렉터리에서 파일명 제거 (참조 카운트 -1)
3. 참조 카운트 확인
   - 0이면: inode와 데이터 블록 실제 삭제
   - 0이 아니면: 파일 보이지 않지만 데이터 유지
```

#### 실제 상황 예시

```bash
# 프로세스가 파일 사용 중
$ lsof /var/log/access.log
apache 1234 user 3w /var/log/access.log

# 파일 삭제 (디렉터리 참조만 제거)
$ rm /var/log/access.log
$ df -h  # 디스크 사용률 변화 없음

# 프로세스 재시작 후 실제 삭제
$ systemctl restart apache
$ df -h  # 이제 사용률 감소
```

이는 **시스템 안정성을 위한 설계**로, 실행 중인 프로세스의 갑작스러운 파일 접근 불가 상황 방지

## 6. 현대 파일 시스템

### 주요 파일 시스템

- **EXT 계열**: Linux에서 사용 (유닉스 파일 시스템 기반, inode 구조)
- **NTFS**: Windows에서 사용
- **FAT**: 이동식 저장장치에서 사용 (호환성)
- **저널링 파일 시스템**: 시스템 안정성 향상

### 발전 방향

- 대용량 파일 지원
- 빠른 접근 속도
- 안정성 및 복구 기능 강화
- 다양한 메타데이터 지원

---

**핵심 정리**

- 파일 시스템: 데이터 저장과 관리의 핵심 기술
- 저장 장치 사용 전 파티셔닝과 포맷팅 필수
- 할당 방식에 따른 성능과 효율성 차이
- FAT: 테이블 기반, inode: 색인 기반 파일 관리
- 참조 카운트: 파일 삭제의 실제 동작 원리
